{% extends "base.html" %}
{% load static %}
{% load thumbnail %}

{% block title %}People{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user_list.css' %}">

<div class="people-header">
    <h1><i class="fas fa-users"></i> People</h1>
</div>

{% if users %}
    <div class="user-list">
        {% for user in users %}
            <div class="user-item">
                <div class="user-info">
                    {% if user.profile.photo %}
                        <img src="{% thumbnail user.profile.photo 80x80 crop='center' quality=95 %}" alt="{{ user.username }}" class="user-photo">
                    {% else %}
                        <div class="user-photo" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="color: #12c064; font-size: 32px;"></i>
                        </div>
                    {% endif %}

                    <div class="user-details">
                        <h2>
                            <a href="{% url 'user_detail' user.username %}">
                                {{ user.get_full_name|default:user.username }}
                            </a>
                        </h2>
                        <p class="username">@{{ user.username }}</p>

                        {% if user.profile.date_of_birth %}
                            <p class="date-of-birth">
                                <i class="fas fa-birthday-cake" style="color: #12c064;"></i> {{ user.profile.date_of_birth|date:"F j, Y" }}
                            </p>
                        {% endif %}

                        <p class="follower-count">
                            <i class="fas fa-users" style="color: #12c064;"></i> <strong>{{ user.followers.count }}</strong> followers
                        </p>
                    </div>
                </div>

                {% if request.user != user %}
                    <div class="user-actions">
                        {% if user in request.user.following.all %}
                            <a href="#" class="follow btn btn-secondary" 
                               data-id="{{ user.id }}" 
                               data-action="unfollow">
                                <i class="fas fa-user-check"></i> Following
                            </a>
                        {% else %}
                            <a href="#" class="follow btn btn-primary" 
                               data-id="{{ user.id }}" 
                               data-action="follow">
                                <i class="fas fa-user-plus"></i> Follow
                            </a>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted"><i class="fas fa-info-circle"></i> Your profile</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-search"></i>
        <p>No users found</p>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    const url = '{% url "user_follow" %}';
    var options = {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        mode: 'same-origin'
    }
    
    // Handle follow/unfollow buttons
    document.querySelectorAll('a.follow').forEach(button => {
        button.addEventListener('click', function(e){
            e.preventDefault();
            var followButton = this;
            // add request body
            var formData = new FormData();
            formData.append('id', followButton.dataset.id);
            formData.append('action', followButton.dataset.action);
            options['body'] = formData;
            // send HTTP request
            fetch(url, options)
            .then(response => response.json())
            .then(data => {
                if (data['status'] === 'ok')
                {
                    var previousAction = followButton.dataset.action;
                    // toggle button text and data-action
                    var action = previousAction === 'follow' ? 'unfollow' : 'follow';
                    followButton.dataset.action = action;
                    followButton.innerHTML = action === 'follow' 
                        ? '<i class="fas fa-user-plus"></i> Follow' 
                        : '<i class="fas fa-user-check"></i> Following';
                    
                    // toggle button classes
                    if (action === 'follow') {
                        followButton.classList.remove('btn-secondary');
                        followButton.classList.add('btn-primary');
                    } else {
                        followButton.classList.remove('btn-primary');
                        followButton.classList.add('btn-secondary');
                    }
                    
                    // update follower count
                    var followerCount = followButton.closest('.user-item').querySelector('.follower-count strong');
                    if (followerCount) {
                        var totalFollowers = parseInt(followerCount.innerHTML);
                        followerCount.innerHTML = previousAction === 'follow' ? 
                            totalFollowers + 1 : totalFollowers - 1;
                    }
                }
            })
        });
    });
});
</script>

{% endblock %}